<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶å¤¹å¼åˆ†ç±»å†…å®¹ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        body {
            background-color: #f5f5f5;
            padding: 20px;
        }
        /* å¯†ç éªŒè¯ç•Œé¢æ ·å¼ */
        .password-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .password-box {
            width: 400px;
            max-width: 90%;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .password-box h2 {
            margin-bottom: 20px;
            color: #333;
        }
        .password-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        .password-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }
        .password-error {
            color: #dc3545;
            margin-top: 10px;
            display: none;
        }
        /* åŸæœ‰æ ·å¼ä¿ç•™ */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .nav-left button {
            padding: 6px 12px;
            border: none;
            background-color: #007bff;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .nav-left button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .nav-middle {
            display: flex;
            gap: 5px;
        }
        .breadcrumb-item {
            color: #007bff;
            cursor: pointer;
        }
        .breadcrumb-separator {
            color: #666;
        }
        .nav-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .nav-right button {
            padding: 6px 12px;
            border: none;
            background-color: #28a745;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
        }
        .nav-right .tip {
            font-size: 12px;
            color: #666;
        }
        .content-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: calc(100vh - 120px);
            position: relative;
        }
        .empty-tip {
            text-align: center;
            color: #999;
            padding: 50px 0;
        }
        .item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .item:last-child {
            border-bottom: none;
        }
        .item-name {
            flex: 1;
            cursor: pointer;
        }
        .folder-name {
            color: #007bff;
            font-weight: bold;
        }
        .item-actions {
            display: flex;
            gap: 5px;
        }
        .item-actions button {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .edit-btn {
            background-color: #ffc107;
            color: #000;
        }
        .delete-btn {
            background-color: #dc3545;
            color: #fff;
            border: 1px solid #dc3545 !important;
        }
        .move-btn {
            background-color: #007bff;
            color: #fff;
            border: 1px solid #007bff !important;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-close {
            cursor: pointer;
            font-size: 20px;
            color: #666;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-footer button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .cancel-btn {
            background-color: #6c757d;
            color: #fff;
        }
        .confirm-btn {
            background-color: #007bff;
            color: #fff;
        }
        .media-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            display: none;
        }
        .media-item {
            position: relative;
            display: inline-block;
            margin: 10px;
            border: 2px solid transparent;
        }
        .media-item.selected {
            border-color: #007bff;
        }
        .media-content {
            max-width: 200px;
            max-height: 200px;
        }
        .media-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }
        .media-controls button {
            width: 25px;
            height: 25px;
            border: none;
            border-radius: 50%;
            background-color: rgba(0,0,0,0.7);
            color: #fff;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
        }
        .batch-modal .file-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
        }
        .file-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <!-- å¯†ç éªŒè¯ç•Œé¢ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
    <div class="password-container" id="passwordContainer">
        <div class="password-box">
            <h2>è¯·è¾“å…¥è®¿é—®å¯†ç </h2>
            <input type="password" class="password-input" id="passwordInput" placeholder="è¾“å…¥å¯†ç åå›è½¦æˆ–ç‚¹å‡»æŒ‰é’®">
            <button class="password-btn" id="passwordBtn">ç¡®è®¤è®¿é—®</button>
            <div class="password-error" id="passwordError">å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ï¼</div>
        </div>
    </div>

    <!-- ä¸»é¡µå†…å®¹ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="mainContent" style="display: none;">
        <!-- å¯¼èˆªæ  -->
        <div class="navbar">
            <div class="nav-left">
                <button data-action="back" disabled>â† è¿”å›ä¸Šä¸€çº§</button>
                <button data-action="home">ğŸ  è¿”å›é¦–é¡µ</button>
            </div>
            <div class="nav-middle" id="breadcrumb"></div>
            <div class="nav-right">
                <button data-action="add">+ å•ä¸ªæ·»åŠ </button>
                <button data-action="batchImport">ğŸ“ æ‰¹é‡å¯¼å…¥åª’ä½“</button>
                <span class="tip">é€‰ä¸­åª’ä½“ï¼šæ–¹å‘é”®ç§»åŠ¨ | Â±é”®ç¼©æ”¾</span>
            </div>
        </div>

        <!-- å†…å®¹å®¹å™¨ -->
        <div class="content-container" id="contentContainer">
            <div class="empty-tip">æš‚æ— å†…å®¹ï¼Œç‚¹å‡»å³ä¸Šè§’æŒ‰é’®æ·»åŠ </div>
        </div>

        <!-- å•ä¸ªæ·»åŠ å¼¹çª— -->
        <div class="modal" id="addModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">æ·»åŠ å†…å®¹</h3>
                    <span class="modal-close" data-action="closeAddModal">&times;</span>
                </div>
                <div class="form-group">
                    <label for="itemType">å†…å®¹ç±»å‹</label>
                    <select id="itemType">
                        <option value="folder">åˆ†ç±»ï¼ˆæ–‡ä»¶å¤¹ï¼‰</option>
                        <option value="text">æ–‡æœ¬å†…å®¹</option>
                        <option value="image">å›¾ç‰‡</option>
                        <option value="video">è§†é¢‘</option>
                        <option value="audio">MP3éŸ³é¢‘</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="itemName">åç§°ï¼ˆæ”¯æŒæ¢è¡Œï¼‰</label>
                    <textarea id="itemName" rows="3"></textarea>
                </div>
                <div class="form-group" id="fileInputGroup" style="display: none;">
                    <label for="itemFile">é€‰æ‹©æ–‡ä»¶</label>
                    <input type="file" id="itemFile">
                    <div class="media-preview" id="mediaPreview"></div>
                </div>
                <div class="modal-footer">
                    <button class="cancel-btn" data-action="closeAddModal">å–æ¶ˆ</button>
                    <button class="confirm-btn" data-action="confirmAdd">ç¡®è®¤æ·»åŠ </button>
                </div>
            </div>
        </div>

        <!-- æ‰¹é‡å¯¼å…¥å¼¹çª— -->
        <div class="modal" id="batchModal" style="display: none;">
            <div class="modal-content batch-modal">
                <div class="modal-header">
                    <h3>æ‰¹é‡å¯¼å…¥åª’ä½“</h3>
                    <span class="modal-close" data-action="closeBatchModal">&times;</span>
                </div>
                <div class="form-group">
                    <label for="batchFiles">é€‰æ‹©å¤šä¸ªåª’ä½“æ–‡ä»¶</label>
                    <input type="file" id="batchFiles" multiple>
                    <div class="file-list" id="batchFileList"></div>
                </div>
                <div class="modal-footer">
                    <button class="cancel-btn" data-action="closeBatchModal">å–æ¶ˆ</button>
                    <button class="confirm-btn" data-action="confirmBatch">ç¡®è®¤å¯¼å…¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å¯†ç éªŒè¯é…ç½®
        const ACCESS_PASSWORD = 'lzryyxhwzy'; // ä½ æŒ‡å®šçš„è®¿é—®å¯†ç 
        let isAuthenticated = false; // æ˜¯å¦éªŒè¯é€šè¿‡

        // æ ¸å¿ƒæ•°æ®ç»“æ„ï¼šæ ‘å½¢ç»“æ„å­˜å‚¨åˆ†ç±»å’Œå†…å®¹
        let treeData = JSON.parse(localStorage.getItem('treeData')) || {
            name: 'é¦–é¡µ',
            id: 'root',
            type: 'folder',
            children: []
        };
        let currentNode = treeData; // å½“å‰æ‰€åœ¨èŠ‚ç‚¹
        let selectedMedia = null; // é€‰ä¸­çš„åª’ä½“å…ƒç´ 
        let mediaScale = 1.0; // åª’ä½“ç¼©æ”¾æ¯”ä¾‹
        let mediaPosition = { x: 0, y: 0 }; // åª’ä½“ä½ç½®
        let editTargetItem = null; // ç¼–è¾‘çš„ç›®æ ‡é¡¹

        // ===================== æ ¸å¿ƒï¼šäº‹ä»¶å§”æ‰˜ï¼ˆè§£å†³ç‚¹å‡»æ— ååº”çš„å…³é”®ï¼‰ =====================
        function initEventDelegate() {
            // ç»™æ•´ä¸ªæ–‡æ¡£ç»‘å®šäº‹ä»¶å§”æ‰˜ï¼Œä¸ç®¡å…ƒç´ æ˜¯å¦éšè—éƒ½èƒ½è§¦å‘
            document.addEventListener('click', function(e) {
                // æœªéªŒè¯å¯†ç æ—¶ï¼Œåªå“åº”å¯†ç ç›¸å…³æ“ä½œ
                if (!isAuthenticated) {
                    const target = e.target;
                    if (target.id === 'passwordBtn' || (target.id === 'passwordInput' && e.key === 'Enter')) {
                        validatePassword();
                    }
                    return;
                }

                // éªŒè¯é€šè¿‡åï¼Œå“åº”æ‰€æœ‰æ“ä½œ
                const action = e.target.dataset.action || e.target.parentElement.dataset.action;
                switch(action) {
                    // å¯¼èˆªæ æŒ‰é’®
                    case 'back':
                        goBack();
                        break;
                    case 'home':
                        goHome();
                        break;
                    case 'add':
                        openAddModal();
                        break;
                    case 'batchImport':
                        openBatchModal();
                        break;
                    
                    // æ·»åŠ å¼¹çª—
                    case 'closeAddModal':
                        closeAddModal();
                        break;
                    case 'confirmAdd':
                        confirmAddItem();
                        break;
                    
                    // æ‰¹é‡å¼¹çª—
                    case 'closeBatchModal':
                        closeBatchModal();
                        break;
                    case 'confirmBatch':
                        confirmBatchImport();
                        break;
                    
                    // å†…å®¹é¡¹æ“ä½œ
                    case 'editItem':
                        openEditModal(e.target.dataset.itemId);
                        break;
                    case 'deleteItem':
                        deleteItem(e.target.dataset.itemId);
                        break;
                    case 'moveItem':
                        selectMedia(e.target.dataset.itemId);
                        break;
                    
                    // åª’ä½“ç¼©æ”¾
                    case 'mediaMinus':
                        scaleMedia(e.target.dataset.mediaId, -0.5);
                        break;
                    case 'mediaPlus':
                        scaleMedia(e.target.dataset.mediaId, 0.5);
                        break;
                    
                    // é¢åŒ…å±‘è·³è½¬
                    case 'breadcrumbJump':
                        jumpToBreadcrumb(e.target.dataset.nodeId);
                        break;
                }
            });

            // å¯†ç å›è½¦éªŒè¯
            document.getElementById('passwordInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') validatePassword();
            });

            // æ‰¹é‡æ–‡ä»¶é€‰æ‹©é¢„è§ˆ
            document.getElementById('batchFiles').addEventListener('change', previewBatchFiles);
            
            // åª’ä½“æ–‡ä»¶é€‰æ‹©é¢„è§ˆ
            document.getElementById('itemFile').addEventListener('change', previewMedia);
            
            // å†…å®¹ç±»å‹åˆ‡æ¢
            document.getElementById('itemType').addEventListener('change', function() {
                const type = this.value;
                const fileGroup = document.getElementById('fileInputGroup');
                if (['image', 'video', 'audio'].includes(type)) {
                    fileGroup.style.display = 'block';
                    document.getElementById('itemFile').value = '';
                    document.getElementById('mediaPreview').style.display = 'none';
                } else {
                    fileGroup.style.display = 'none';
                }
            });

            // é”®ç›˜æ§åˆ¶åª’ä½“
            document.addEventListener('keydown', (e) => {
                if (!selectedMedia || !isAuthenticated) return;
                
                switch(e.key) {
                    case 'ArrowUp':
                        moveMedia(0, -10);
                        e.preventDefault();
                        break;
                    case 'ArrowDown':
                        moveMedia(0, 10);
                        e.preventDefault();
                        break;
                    case 'ArrowLeft':
                        moveMedia(-10, 0);
                        e.preventDefault();
                        break;
                    case 'ArrowRight':
                        moveMedia(10, 0);
                        e.preventDefault();
                        break;
                    case '+':
                    case '=':
                        scaleMedia(selectedMedia, 0.5);
                        e.preventDefault();
                        break;
                    case '-':
                    case '_':
                        scaleMedia(selectedMedia, -0.5);
                        e.preventDefault();
                        break;
                }
            });
        }

        // ===================== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° =====================
        // éªŒè¯å¯†ç 
        function validatePassword() {
            const inputVal = document.getElementById('passwordInput').value.trim();
            const passwordError = document.getElementById('passwordError');
            
            if (inputVal === ACCESS_PASSWORD) {
                isAuthenticated = true;
                document.getElementById('passwordContainer').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                initMainPage();
            } else {
                passwordError.style.display = 'block';
                document.getElementById('passwordInput').value = '';
                setTimeout(() => {
                    passwordError.style.display = 'none';
                }, 3000);
            }
        }

        // åˆå§‹åŒ–ä¸»é¡µ
        function initMainPage() {
            renderBreadcrumb();
            renderContent();
        }

        // è¿”å›ä¸Šä¸€çº§
        function goBack() {
            const path = getPathToNode(currentNode);
            if (path.length > 1) {
                currentNode = path[path.length - 2];
                renderBreadcrumb();
                renderContent();
                document.querySelector('[data-action="back"]').disabled = currentNode.id === 'root';
            }
        }

        // è¿”å›é¦–é¡µ
        function goHome() {
            currentNode = treeData;
            renderBreadcrumb();
            renderContent();
            document.querySelector('[data-action="back"]').disabled = true;
        }

        // æ¸²æŸ“é¢åŒ…å±‘
        function renderBreadcrumb() {
            const breadcrumbEl = document.getElementById('breadcrumb');
            breadcrumbEl.innerHTML = '';
            
            const path = getPathToNode(currentNode);
            path.forEach((node, index) => {
                const itemEl = document.createElement('span');
                itemEl.className = 'breadcrumb-item';
                itemEl.textContent = node.name;
                itemEl.dataset.action = 'breadcrumbJump';
                itemEl.dataset.nodeId = node.id;
                breadcrumbEl.appendChild(itemEl);

                if (index < path.length - 1) {
                    const separatorEl = document.createElement('span');
                    separatorEl.className = 'breadcrumb-separator';
                    separatorEl.textContent = '/';
                    breadcrumbEl.appendChild(separatorEl);
                }
            });
        }

        // é¢åŒ…å±‘è·³è½¬
        function jumpToBreadcrumb(nodeId) {
            // æŸ¥æ‰¾ç›®æ ‡èŠ‚ç‚¹
            function findNode(targetId, current) {
                if (current.id === targetId) return current;
                if (current.children) {
                    for (let child of current.children) {
                        const res = findNode(targetId, child);
                        if (res) return res;
                    }
                }
                return null;
            }
            
            const targetNode = findNode(nodeId, treeData);
            if (targetNode) {
                currentNode = targetNode;
                renderBreadcrumb();
                renderContent();
                document.querySelector('[data-action="back"]').disabled = currentNode.id === 'root';
            }
        }

        // è·å–èŠ‚ç‚¹è·¯å¾„
        function getPathToNode(node) {
            const path = [];
            function findPath(current, target) {
                path.push(current);
                if (current.id === target.id) return true;
                if (current.children) {
                    for (let child of current.children) {
                        if (findPath(child, target)) return true;
                    }
                }
                path.pop();
                return false;
            }
            findPath(treeData, node);
            return path;
        }

        // æ¸²æŸ“å†…å®¹
        function renderContent() {
            const container = document.getElementById('contentContainer');
            container.innerHTML = '';

            if (!currentNode.children || currentNode.children.length === 0) {
                container.innerHTML = '<div class="empty-tip">æš‚æ— å†…å®¹ï¼Œç‚¹å‡»å³ä¸Šè§’æŒ‰é’®æ·»åŠ </div>';
                return;
            }

            currentNode.children.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'item';

                // å†…å®¹åç§°
                const nameEl = document.createElement('div');
                nameEl.className = 'item-name';
                
                if (item.type === 'folder') {
                    nameEl.className += ' folder-name';
                    nameEl.textContent = item.name;
                    nameEl.dataset.action = 'breadcrumbJump';
                    nameEl.dataset.nodeId = item.id;
                } else if (item.type === 'text') {
                    nameEl.textContent = item.name;
                } else if (['image', 'video', 'audio'].includes(item.type)) {
                    // åª’ä½“å†…å®¹
                    const mediaEl = document.createElement('div');
                    mediaEl.className = 'media-item';
                    mediaEl.dataset.mediaId = item.id;
                    
                    const mediaContent = document.createElement(item.type === 'audio' ? 'audio' : item.type);
                    mediaContent.className = 'media-content';
                    mediaContent.controls = true;
                    mediaContent.src = item.path;
                    
                    // åª’ä½“æ§åˆ¶æŒ‰é’®
                    const controlsEl = document.createElement('div');
                    controlsEl.className = 'media-controls';
                    const minusBtn = document.createElement('button');
                    minusBtn.textContent = '-';
                    minusBtn.dataset.action = 'mediaMinus';
                    minusBtn.dataset.mediaId = item.id;
                    const plusBtn = document.createElement('button');
                    plusBtn.textContent = '+';
                    plusBtn.dataset.action = 'mediaPlus';
                    plusBtn.dataset.mediaId = item.id;
                    controlsEl.appendChild(minusBtn);
                    controlsEl.appendChild(plusBtn);
                    
                    mediaEl.appendChild(mediaContent);
                    mediaEl.appendChild(controlsEl);
                    
                    // åª’ä½“é€‰ä¸­äº‹ä»¶
                    mediaEl.onclick = (e) => {
                        e.stopPropagation();
                        if (selectedMedia) {
                            selectedMedia.classList.remove('selected');
                        }
                        selectedMedia = mediaEl;
                        selectedMedia.classList.add('selected');
                        mediaScale = 1.0;
                        mediaPosition = { x: 0, y: 0 };
                    };
                    
                    nameEl.appendChild(mediaEl);
                }

                // æ“ä½œæŒ‰é’®
                const actionsEl = document.createElement('div');
                actionsEl.className = 'item-actions';
                
                // ç¼–è¾‘æŒ‰é’®
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.textContent = 'ç¼–è¾‘';
                editBtn.dataset.action = 'editItem';
                editBtn.dataset.itemId = item.id;
                actionsEl.appendChild(editBtn);
                
                // åˆ é™¤æŒ‰é’®
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'åˆ é™¤';
                deleteBtn.dataset.action = 'deleteItem';
                deleteBtn.dataset.itemId = item.id;
                actionsEl.appendChild(deleteBtn);
                
                // ç§»åŠ¨æŒ‰é’®ï¼ˆä»…åª’ä½“ï¼‰
                if (['image', 'video', 'audio'].includes(item.type)) {
                    const moveBtn = document.createElement('button');
                    moveBtn.className = 'move-btn';
                    moveBtn.textContent = 'ç§»åŠ¨';
                    moveBtn.dataset.action = 'moveItem';
                    moveBtn.dataset.itemId = item.id;
                    actionsEl.appendChild(moveBtn);
                }

                itemEl.appendChild(nameEl);
                itemEl.appendChild(actionsEl);
                container.appendChild(itemEl);
            });
        }

        // æ‰“å¼€æ·»åŠ å¼¹çª—
        function openAddModal() {
            editTargetItem = null; // æ¸…ç©ºç¼–è¾‘ç›®æ ‡
            document.getElementById('modalTitle').textContent = 'æ·»åŠ å†…å®¹';
            document.getElementById('itemType').value = 'folder';
            document.getElementById('itemName').value = '';
            document.getElementById('fileInputGroup').style.display = 'none';
            document.getElementById('mediaPreview').style.display = 'none';
            document.getElementById('addModal').style.display = 'flex';
        }

        // å…³é—­æ·»åŠ å¼¹çª—
        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
        }

        // é¢„è§ˆåª’ä½“
        function previewMedia() {
            const fileInput = document.getElementById('itemFile');
            const previewEl = document.getElementById('mediaPreview');
            const file = fileInput.files[0];
            if (!file) return;

            const type = document.getElementById('itemType').value;
            previewEl.style.display = 'block';
            
            if (type === 'image') {
                previewEl.innerHTML = `<img src="${URL.createObjectURL(file)}" style="max-width: 100%; max-height: 200px;">`;
            } else if (type === 'video') {
                previewEl.innerHTML = `<video src="${URL.createObjectURL(file)}" controls style="max-width: 100%; max-height: 200px;"></video>`;
            } else if (type === 'audio') {
                previewEl.innerHTML = `<audio src="${URL.createObjectURL(file)}" controls style="width: 100%;"></audio>`;
            }
        }

        // ç¡®è®¤æ·»åŠ /ç¼–è¾‘
        function confirmAddItem() {
            const type = document.getElementById('itemType').value;
            const name = document.getElementById('itemName').value.trim();
            
            if (!name) {
                alert('åç§°ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            // ç¼–è¾‘æ¨¡å¼
            if (editTargetItem) {
                // æ£€æŸ¥åŒåï¼ˆæ’é™¤è‡ªå·±ï¼‰
                const hasDuplicate = currentNode.children.some(i => i.name === name && i.id !== editTargetItem.id);
                if (hasDuplicate) {
                    alert('è¯¥åç§°å·²å­˜åœ¨ï¼Œè¯·æ›´æ¢ï¼');
                    return;
                }

                editTargetItem.name = name;
                localStorage.setItem('treeData', JSON.stringify(treeData));
                closeAddModal();
                renderContent();
                editTargetItem = null;
                return;
            }

            // æ·»åŠ æ¨¡å¼
            // æ£€æŸ¥åŒå
            const hasDuplicate = currentNode.children.some(item => item.name === name);
            if (hasDuplicate) {
                alert('è¯¥åç§°å·²å­˜åœ¨ï¼Œè¯·æ›´æ¢ï¼');
                return;
            }

            const newItem = {
                id: Date.now().toString(),
                name: name,
                type: type
            };

            if (['image', 'video', 'audio'].includes(type)) {
                const fileInput = document.getElementById('itemFile');
                const file = fileInput.files[0];
                if (!file) {
                    alert('è¯·é€‰æ‹©æ–‡ä»¶ï¼');
                    return;
                }

                // æ„å»ºç›¸å¯¹è·¯å¾„
                let folder = '';
                if (type === 'image') folder = 'images';
                else if (type === 'video') folder = 'videos';
                else if (type === 'audio') folder = 'audios';
                
                newItem.path = `./${folder}/${file.name}`;
                alert(`è¯·å°†æ–‡ä»¶ "${file.name}" æ”¾å…¥ GitHub ä»“åº“çš„ ${folder} æ–‡ä»¶å¤¹ä¸­ï¼Œå¦åˆ™æ— æ³•åŠ è½½ï¼`);
            }

            currentNode.children = currentNode.children || [];
            currentNode.children.push(newItem);
            localStorage.setItem('treeData', JSON.stringify(treeData));
            
            closeAddModal();
            renderContent();
        }

        // æ‰“å¼€æ‰¹é‡å¯¼å…¥å¼¹çª—
        function openBatchModal() {
            document.getElementById('batchFiles').value = '';
            document.getElementById('batchFileList').innerHTML = '';
            document.getElementById('batchModal').style.display = 'flex';
        }

        // å…³é—­æ‰¹é‡å¯¼å…¥å¼¹çª—
        function closeBatchModal() {
            document.getElementById('batchModal').style.display = 'none';
        }

        // é¢„è§ˆæ‰¹é‡æ–‡ä»¶
        function previewBatchFiles() {
            const files = document.getElementById('batchFiles').files;
            const fileListEl = document.getElementById('batchFileList');
            fileListEl.innerHTML = '';

            if (files.length === 0) return;

            for (let file of files) {
                const fileEl = document.createElement('div');
                fileEl.className = 'file-item';
                
                let type = '';
                if (file.type.startsWith('image/')) type = 'å›¾ç‰‡';
                else if (file.type.startsWith('video/')) type = 'è§†é¢‘';
                else if (file.type.startsWith('audio/')) type = 'éŸ³é¢‘';
                else type = 'ä¸æ”¯æŒçš„ç±»å‹';
                
                fileEl.textContent = `${file.name} (${type})`;
                fileListEl.appendChild(fileEl);
            }
        }

        // ç¡®è®¤æ‰¹é‡å¯¼å…¥
        function confirmBatchImport() {
            const files = document.getElementById('batchFiles').files;
            if (files.length === 0) {
                alert('è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶ï¼');
                return;
            }

            let imported = 0;
            let duplicate = 0;
            let unsupported = 0;

            currentNode.children = currentNode.children || [];

            for (let file of files) {
                let type = '';
                if (file.type.startsWith('image/')) type = 'image';
                else if (file.type.startsWith('video/')) type = 'video';
                else if (file.type.startsWith('audio/')) type = 'audio';
                else {
                    unsupported++;
                    continue;
                }

                const name = file.name.substring(0, file.name.lastIndexOf('.'));
                if (currentNode.children.some(item => item.name === name)) {
                    duplicate++;
                    continue;
                }

                let folder = '';
                if (type === 'image') folder = 'images';
                else if (type === 'video') folder = 'videos';
                else if (type === 'audio') folder = 'audios';

                const newItem = {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: name,
                    type: type,
                    path: `./${folder}/${file.name}`
                };

                currentNode.children.push(newItem);
                imported++;
            }

            localStorage.setItem('treeData', JSON.stringify(treeData));
            
            alert(`æ‰¹é‡å¯¼å…¥å®Œæˆï¼
æˆåŠŸå¯¼å…¥ï¼š${imported} ä¸ª
é‡å¤è·³è¿‡ï¼š${duplicate} ä¸ª
ä¸æ”¯æŒç±»å‹ï¼š${unsupported} ä¸ª

è¯·å°†æ‰€æœ‰å¯¼å…¥çš„æ–‡ä»¶åˆ†åˆ«æ”¾å…¥ GitHub ä»“åº“çš„ images/videos/audios æ–‡ä»¶å¤¹ä¸­ï¼`);

            closeBatchModal();
            renderContent();
        }

        // æ‰“å¼€ç¼–è¾‘å¼¹çª—
        function openEditModal(itemId) {
            // æŸ¥æ‰¾è¦ç¼–è¾‘çš„é¡¹
            const item = currentNode.children.find(i => i.id === itemId);
            if (!item) return;
            
            editTargetItem = item;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å†…å®¹';
            document.getElementById('itemType').value = item.type;
            document.getElementById('itemType').disabled = true;
            document.getElementById('itemName').value = item.name;
            document.getElementById('fileInputGroup').style.display = 'none';
            document.getElementById('addModal').style.display = 'flex';
        }

        // åˆ é™¤å†…å®¹
        function deleteItem(itemId) {
            const item = currentNode.children.find(i => i.id === itemId);
            if (!item || !confirm(`ç¡®å®šè¦åˆ é™¤ "${item.name}" å—ï¼Ÿ`)) return;
            
            currentNode.children = currentNode.children.filter(i => i.id !== itemId);
            localStorage.setItem('treeData', JSON.stringify(treeData));
            renderContent();
        }

        // é€‰ä¸­åª’ä½“
        function selectMedia(itemId) {
            const mediaEl = document.querySelector(`[data-media-id="${itemId}"]`);
            if (mediaEl) {
                if (selectedMedia) {
                    selectedMedia.classList.remove('selected');
                }
                selectedMedia = mediaEl;
                selectedMedia.classList.add('selected');
                mediaScale = 1.0;
                mediaPosition = { x: 0, y: 0 };
            }
        }

        // ç§»åŠ¨åª’ä½“
        function moveMedia(dx, dy) {
            if (!selectedMedia) return;
            
            mediaPosition.x += dx;
            mediaPosition.y += dy;
            selectedMedia.style.transform = `translate(${mediaPosition.x}px, ${mediaPosition.y}px) scale(${mediaScale})`;
        }

        // ç¼©æ”¾åª’ä½“
        function scaleMedia(mediaId, delta) {
            // å¦‚æœä¼ çš„æ˜¯å…ƒç´ ï¼Œç›´æ¥ç”¨ï¼›å¦‚æœä¼ çš„æ˜¯IDï¼ŒæŸ¥æ‰¾å…ƒç´ 
            let mediaEl = typeof mediaId === 'object' ? mediaId : document.querySelector(`[data-media-id="${mediaId}"]`);
            if (!mediaEl) return;
            
            mediaScale = Math.max(0.05, Math.min(20.0, mediaScale + delta));
            mediaEl.style.transform = `translate(${mediaPosition.x}px, ${mediaPosition.y}px) scale(${mediaScale})`;
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            initEventDelegate(); // ä¼˜å…ˆåˆå§‹åŒ–äº‹ä»¶å§”æ‰˜
        };
    </script>
</body>
</html>